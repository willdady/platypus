# Super Admin Role Refactoring Plan (Updated)

## Executive Summary

This plan addresses the issue where authenticated super admin users cannot access the `/create` (Organisation Create) page because the frontend's [`ProtectedRoute`](apps/frontend/components/protected-route.tsx:163) component checks for a `user.role` field that doesn't exist in the database or session.

**Current Problem:** The frontend checks `user?.role !== "admin"` but the user table has no `role` field, causing all users (including super admins) to fail the check.

**Root Cause:** Misalignment between backend (environment variable-based super admin check) and frontend (database field expectation).

**Solution:** Add `role` field via better-auth configuration, regenerate schema, and completely deprecate `SUPER_ADMIN_EMAILS`.

---

## Current Implementation Analysis

### Backend Implementation

**Super Admin Logic:**

- Based on [`SUPER_ADMIN_EMAILS` environment variable](apps/backend/.example.env:7) (comma-separated email list)
- Function [`isSuperAdmin()`](apps/backend/src/middleware/authorization.ts:26-30) checks if user email matches
- Middleware [`requireSuperAdmin`](apps/backend/src/middleware/authorization.ts:252) protects routes like org creation
- Used in 3 locations:
  1. [`organisation.post("/")`](apps/backend/src/routes/organisation.ts:28) - Create organisation
  2. [`organisation.get("/")`](apps/backend/src/routes/organisation.ts:48) - List all orgs for super admins
  3. [`member.get("/")`](apps/backend/src/routes/member.ts:70) - Include `isSuperAdmin` flag in member list

**User Table Schema:**

```typescript
// apps/backend/src/db/auth-schema.ts (Generated by better-auth)
export const user = pgTable("user", {
  id: text("id").primaryKey(),
  name: text("name").notNull(),
  email: text("email").notNull().unique(),
  emailVerified: boolean("email_verified").default(false).notNull(),
  image: text("image"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
  // ❌ NO role field
});
```

### Frontend Implementation

**Auth Provider:**

- Uses better-auth's `useSession()` hook to get session data
- Session includes base `user` object (id, name, email, etc.)
- Does NOT include `role` field or super admin status

**Protected Route Component:**

- Line 99: Checks `user?.role !== "admin"` for super admin access
- Line 163: Shows "Super Admin Access Required" error
- **This check ALWAYS fails** because `user.role` is always `undefined`

---

## Solution Design

### Approach: Add `role` Field via Better-Auth Configuration

Per [better-auth documentation](https://www.better-auth.com/docs/concepts/users-accounts#extending-core-schema), we'll add custom fields using the `additionalFields` property in the auth config. Better-auth will automatically:

1. Include the field in the generated schema
2. Expose it in session data
3. Infer it in TypeScript types

#### Design Decisions

**Role Types:**

- `"user"` (default) - Regular user
- `"admin"` - Super admin with platform-wide privileges

**Configuration Strategy:**

- Define `role` field via `betterAuth()` config's `user.additionalFields`
- Regenerate schema using better-auth CLI
- Field will be automatically included in sessions (no extra config needed)

**Migration Strategy:**

- ✅ Add role field via better-auth config
- ✅ Regenerate schema → Apply with `drizzle-kit-push`
- ✅ Create migration script to set existing admin to `role = "admin"`
- ✅ Update all `isSuperAdmin()` calls to check `user.role`
- ✅ **COMPLETELY REMOVE** `SUPER_ADMIN_EMAILS` environment variable
- ✅ No backwards compatibility needed - clean cutover

---

## Better-Auth Configuration Changes

### 1. Update [`auth.ts`](apps/backend/src/auth.ts)

Add `role` field to user schema via `additionalFields`:

```typescript
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { db } from "./index.ts";
import * as authSchema from "./db/auth-schema.ts";

export const auth = betterAuth({
  baseURL: process.env.BETTER_AUTH_URL || "http://localhost:4000",
  basePath: "/auth",
  database: drizzleAdapter(db, {
    provider: "pg",
    schema: authSchema,
  }),
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: false,
  },
  session: {
    expiresIn: 60 * 60 * 24 * 7, // 7 days
    updateAge: 60 * 60 * 24, // Update session every 24 hours
    cookieCache: {
      enabled: true,
      maxAge: 5 * 60, // 5 minutes
    },
  },
  trustedOrigins: process.env.ALLOWED_ORIGINS?.split(",") || [],
  // ✅ NEW: Add custom user fields
  user: {
    additionalFields: {
      role: {
        type: ["user", "admin"],
        required: true,
        defaultValue: "user",
        input: false, // Don't allow users to set their own role
      },
    },
  },
});
```

**Key Properties:**

- `type: ["user", "admin"]` - Enum-like type (TypeScript will infer as union type)
- `required: true` - Field is mandatory
- `defaultValue: "user"` - New users default to regular user role
- `input: false` - Prevents users from setting role during sign-up (security)

### 2. Regenerate Auth Schema

After updating `auth.ts`, regenerate the schema:

```bash
pnpm --dir apps/backend dlx @better-auth/cli@latest generate \
  --config ./src/auth.ts \
  --output ./src/db/auth-schema.ts \
  --yes
```

This will regenerate [`auth-schema.ts`](apps/backend/src/db/auth-schema.ts) with the new `role` field:

```typescript
export const user = pgTable("user", {
  id: text("id").primaryKey(),
  name: text("name").notNull(),
  email: text("email").notNull().unique(),
  emailVerified: boolean("email_verified").default(false).notNull(),
  image: text("image"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
  // ✅ NEW: Auto-generated from auth config
  role: text("role").notNull().default("user"),
});
```

### 3. Apply Schema to Database

```bash
# Ensure dev environment is running (database must be up)
pnpm dev

# In another terminal, push schema changes
pnpm drizzle-kit-push
```

---

## Database Migration Script

### Create Migration Script

**File:** `apps/backend/scripts/migrate-admin-role.ts`

```typescript
import { db } from "../src/index.ts";
import { user } from "../src/db/auth-schema.ts";
import { eq } from "drizzle-orm";

/**
 * Migration script to set the default admin user to role="admin"
 * Run this ONCE after deploying the role field to the database
 */
const migrateAdminRole = async () => {
  const adminEmail = "admin@example.com";

  console.log(`Setting role="admin" for ${adminEmail}...`);

  const result = await db
    .update(user)
    .set({ role: "admin" })
    .where(eq(user.email, adminEmail))
    .returning({ id: user.id, email: user.email, role: user.role });

  if (result.length === 0) {
    console.error(`❌ User not found: ${adminEmail}`);
    process.exit(1);
  }

  console.log(`✅ Updated user to admin role:`);
  console.log(`   - ${result[0].email} (${result[0].id})`);
  console.log(`   - Role: ${result[0].role}`);
};

migrateAdminRole()
  .then(() => {
    console.log("✅ Migration complete");
    process.exit(0);
  })
  .catch((err) => {
    console.error("❌ Migration failed:", err);
    process.exit(1);
  });
```

**Run:**

```bash
pnpm --dir apps/backend tsx scripts/migrate-admin-role.ts
```

---

## Backend Code Changes

### 1. Update [`isSuperAdmin()` function](apps/backend/src/middleware/authorization.ts:26-30)

**Complete replacement - no backwards compatibility:**

````typescript
/**
 * Checks if a user is a super admin based on their role field.
 * Super admins have full platform-level access.
 *
 * @param user - The user object with role field
 * @returns True if the user is a super admin, false otherwise
 *
 * @example
 * ```typescript
 * if (isSuperAdmin(user)) {
 *   // Grant full platform access
 * }
 * ```
 */
const isSuperAdmin = (user: { role: string }): boolean => {
  return user.role === "admin";
};
````

### 2. Update [`requireSuperAdmin` middleware](apps/backend/src/middleware/authorization.ts:252)

````typescript
/**
 * Middleware that restricts access to super admins only.
 *
 * **Purpose:**
 * Used for platform-level administrative operations that should only be
 * accessible to users with role="admin".
 *
 * **Behavior:**
 * - Checks if authenticated user's role is "admin"
 * - Returns 403 if user is not a super admin
 * - Allows request to proceed if user is a super admin
 *
 * **Use Cases:**
 * - Creating new organisations
 * - Platform-wide configuration changes
 * - System administration tasks
 *
 * @example
 * ```typescript
 * // Restrict organisation creation to super admins only
 * app.post("/organisations", requireAuth, requireSuperAdmin, handler);
 * ```
 */
export const requireSuperAdmin = createMiddleware(async (c, next) => {
  const user = c.get("user");

  if (!isSuperAdmin(user)) {
    return c.json({ error: "Super admin access required" }, 403);
  }

  await next();
});
````

### 3. Update all middleware calls in [`authorization.ts`](apps/backend/src/middleware/authorization.ts)

**Update [`requireOrgAccess()`](apps/backend/src/middleware/authorization.ts:91):**

```typescript
export const requireOrgAccess = (requiredRoles?: OrgRole[]) =>
  createMiddleware(async (c, next) => {
    const user = c.get("user");
    const db = c.get("db");

    // Super admins bypass all checks
    if (isSuperAdmin(user)) {
      // ✅ Pass full user object
      const superAdminMembership: SuperAdminOrgMembership = {
        role: "admin",
        isSuperAdmin: true,
      };
      c.set("orgMembership", superAdminMembership);
      await next();
      return;
    }

    // ... rest of function unchanged
  });
```

**Update [`requireWorkspaceAccess()`](apps/backend/src/middleware/authorization.ts:176):**

```typescript
export const requireWorkspaceAccess = (requiredRoles?: WorkspaceRole[]) =>
  createMiddleware(async (c, next) => {
    const user = c.get("user");
    const db = c.get("db");
    const orgMembership = c.get("orgMembership");

    // Super admins bypass all checks
    if (isSuperAdmin(user)) {
      // ✅ Pass full user object
      c.set("workspaceRole", "admin");
      c.set("workspaceMembership", null);
      await next();
      return;
    }

    // ... rest of function unchanged
  });
```

### 4. Update route handlers

**File:** [`apps/backend/src/routes/organisation.ts`](apps/backend/src/routes/organisation.ts:48)

```typescript
/** List all organisations (filtered to user's memberships) */
organisation.get("/", requireAuth, async (c) => {
  const user = c.get("user")!;

  // Super admins see all organisations
  if (isSuperAdmin(user)) {
    // ✅ Pass full user object
    const results = await db.select().from(organisationTable);
    return c.json({ results });
  }

  // Regular users see only their organisations
  // ... rest unchanged
});
```

**File:** [`apps/backend/src/routes/member.ts`](apps/backend/src/routes/member.ts:70,138)

Update both occurrences where `isSuperAdmin` is used in response:

```typescript
// Line ~70 - Update in list members response
return {
  ...m,
  user: userInfo,
  workspaces,
  isSuperAdmin: isSuperAdmin(m.user), // ✅ Pass full user object
};

// Line ~138 - Update in single member response
return c.json({
  ...membership,
  user: userInfo,
  workspaces,
  isSuperAdmin: isSuperAdmin(membership.user), // ✅ Pass full user object
});
```

### 5. Update default user creation in [`index.ts`](apps/backend/index.ts:44-55)

Update the default admin user creation to set role:

```typescript
console.log("Creating default user...");
const defaultEmail = "admin@example.com";
const defaultPassword = "admin123";

try {
  const result = await auth.api.signUpEmail({
    body: {
      email: defaultEmail,
      password: defaultPassword,
      name: "Admin User",
      // Note: role is set to "user" by default (input: false prevents setting it)
    },
  });

  if (!result.user) {
    throw new Error("Failed to get user from sign up response");
  }

  console.log(`- User created: ${defaultEmail}`);

  // ✅ NEW: Update role to admin after creation
  await db.update(user)
    .set({ role: "admin" })
    .where(eq(user.id, result.user.id));

  console.log(`- User upgraded to admin role`);

  // Create organization membership with admin role
  // ... rest unchanged
}
```

### 6. Remove `isSuperAdminMembership` function

The [`isSuperAdminMembership` type guard](apps/backend/src/middleware/authorization.ts:51-55) might no longer be needed depending on usage. Review and remove if not used elsewhere.

---

## Frontend Changes

### 1. Update TypeScript Types

Better-auth will automatically infer the `role` field in TypeScript types based on the configuration. The session user object will include:

```typescript
{
  id: string;
  email: string;
  name: string;
  role: "user" | "admin"; // ✅ Auto-inferred from betterAuth config
  // ... other fields
}
```

### 2. Verify [`ProtectedRoute`](apps/frontend/components/protected-route.tsx) works

No changes needed! The existing code will work once `user.role` is populated:

```typescript
// Line 163 - This will now work correctly
if (requireSuperAdmin && user?.role !== "admin") {
  return (
    <AccessDenied
      title="Super Admin Access Required"
      description="You do not have permission to access this page..."
    />
  );
}
```

### 3. Update [`AuthProvider` types](apps/frontend/components/auth-provider.tsx:27-28) (Optional)

Better-auth client types should automatically include the role field. If TypeScript complains, explicitly type it:

```typescript
interface AuthContextType {
  user: {
    id: string;
    email: string;
    name: string;
    role: "user" | "admin";
    // ... other fields
  } | null;
  // ... rest unchanged
}
```

---

## Environment Variable Cleanup

### 1. Remove from `.example.env`

**File:** [`apps/backend/.example.env`](apps/backend/.example.env:7)

```diff
  NODE_OPTIONS="--disable-warning=ExperimentalWarning"
  PORT="4000"
  ALLOWED_ORIGINS="http://localhost:3000"
  DATABASE_URL=postgres://postgres:mypassword@localhost:5432/postgres
  BETTER_AUTH_SECRET=your-secret-key-min-32-chars
  BETTER_AUTH_URL=http://localhost:4000
- SUPER_ADMIN_EMAILS=admin@example.com
  INVITATION_EXPIRY_DAYS=7
```

### 2. Remove from production `.env`

Ensure the production environment variable is also removed after deployment.

### 3. Remove references from code comments

Update any JSDoc or inline comments that reference `SUPER_ADMIN_EMAILS`.

---

## Testing Strategy

### Backend Testing

1. **Schema Generation:**

   ```bash
   # Verify schema regenerates correctly
   pnpm --dir apps/backend dlx @better-auth/cli@latest generate \
     --config ./src/auth.ts \
     --output ./src/db/auth-schema.ts \
     --yes

   # Check that role field is present
   grep "role:" apps/backend/src/db/auth-schema.ts
   ```

2. **Database Push:**

   ```bash
   # Apply schema to database
   pnpm drizzle-kit-push

   # Verify column exists
   # Connect to postgres and run: \d user
   ```

3. **Migration Script:**

   ```bash
   # Run migration
   pnpm --dir apps/backend tsx scripts/migrate-admin-role.ts

   # Verify admin user has role="admin"
   # Query: SELECT email, role FROM "user" WHERE email = 'admin@example.com';
   ```

4. **Super Admin Access:**

   ```bash
   # Sign in as admin@example.com
   # Test POST /organisations (should succeed)
   curl -X POST http://localhost:4000/organisations \
     -H "Content-Type: application/json" \
     -H "Cookie: session=..." \
     -d '{"name": "Test Org"}'
   ```

5. **Regular User Block:**
   ```bash
   # Create regular user (role="user")
   # Test POST /organisations (should return 403)
   ```

### Frontend Testing

1. **Session Data:**
   - Sign in as `admin@example.com`
   - Open DevTools → Network → Find `get-session` request
   - Verify response includes: `user.role: "admin"`

2. **Super Admin Access:**
   - Navigate to `/create`
   - Verify page loads successfully
   - Verify can create organisations

3. **Regular User Block:**
   - Sign in as regular user
   - Navigate to `/create`
   - Verify "Super Admin Access Required" error shows

4. **Type Safety:**
   ```bash
   # Run TypeScript checks
   pnpm --dir apps/frontend tsc --noEmit
   ```

### Integration Testing

1. **New User Sign-Up:**
   - Create new user via `/sign-up`
   - Query database: verify `role = "user"`
   - Verify cannot access super admin routes

2. **Session Refresh:**
   - Sign in as admin
   - Verify role appears in session immediately
   - Refresh page, verify role persists

---

## Implementation Checklist

### Phase 1: Configuration & Schema

- [ ] Update [`auth.ts`](apps/backend/src/auth.ts) with `user.additionalFields.role`
- [ ] Regenerate auth schema via better-auth CLI
- [ ] Verify generated [`auth-schema.ts`](apps/backend/src/db/auth-schema.ts) includes role field
- [ ] Run `pnpm drizzle-kit-push` to apply schema to database
- [ ] Verify `role` column exists in database

### Phase 2: Data Migration

- [ ] Create migration script [`migrate-admin-role.ts`](apps/backend/scripts/migrate-admin-role.ts)
- [ ] Run migration script
- [ ] Verify admin user has `role = "admin"` in database

### Phase 3: Backend Code Updates

- [ ] Update [`isSuperAdmin()` function](apps/backend/src/middleware/authorization.ts:26-30)
- [ ] Update [`requireSuperAdmin` middleware](apps/backend/src/middleware/authorization.ts:252)
- [ ] Update [`requireOrgAccess()`](apps/backend/src/middleware/authorization.ts:91)
- [ ] Update [`requireWorkspaceAccess()`](apps/backend/src/middleware/authorization.ts:176)
- [ ] Update [`organisation.ts`](apps/backend/src/routes/organisation.ts:48) route handler
- [ ] Update [`member.ts`](apps/backend/src/routes/member.ts:70,138) - 2 locations
- [ ] Update default user creation in [`index.ts`](apps/backend/index.ts:44-75)
- [ ] Remove `SUPER_ADMIN_EMAILS` from [`.example.env`](apps/backend/.example.env:7)

### Phase 4: Frontend Updates

- [ ] Verify better-auth client types include `role` field
- [ ] Update [`AuthProvider` types](apps/frontend/components/auth-provider.tsx) if needed
- [ ] Test [`ProtectedRoute`](apps/frontend/components/protected-route.tsx) component

### Phase 5: Testing

- [ ] Test schema generation
- [ ] Test database migration
- [ ] Test super admin can create organisations
- [ ] Test super admin can list all organisations
- [ ] Test regular user blocked from super admin routes
- [ ] Test session includes `user.role` field
- [ ] Test frontend `/create` page loads for admin
- [ ] Test frontend blocks regular users from `/create`
- [ ] Test new user sign-up defaults to `role = "user"`

### Phase 6: Documentation

- [ ] Update [`AGENTS.md`](AGENTS.md) - remove SUPER_ADMIN_EMAILS, document role field
- [ ] Update comments in code referencing environment variable
- [ ] Add JSDoc for role field usage

### Phase 7: Deployment

- [ ] Deploy schema changes to production
- [ ] Run migration script in production
- [ ] Remove `SUPER_ADMIN_EMAILS` from production environment variables
- [ ] Monitor for errors

---

## Rollback Plan

If issues arise after deployment:

### Immediate Code Rollback

1. **Revert code changes** but keep database column:
   - Revert all git commits related to role field
   - Keep database `role` column (doesn't break anything)
   - Re-add `SUPER_ADMIN_EMAILS` to environment variable
   - Redeploy

2. **Session issues:**
   - Role field in database won't cause session errors
   - Better-auth will just include it in session data
   - Frontend can ignore it if code is reverted

### Full Database Rollback (Last Resort)

```sql
-- Remove role column from user table
ALTER TABLE "user" DROP COLUMN "role";
```

Then regenerate auth schema without the `additionalFields` configuration.

---

## Future Enhancements

### 1. Admin Management UI

Create interface for super admins to manage user roles:

- List all users
- Change user roles (`user` → `admin` or vice versa)
- View role permissions

**Implementation:**

- New route: `GET /admin/users` (requireSuperAdmin)
- New route: `PATCH /admin/users/:userId/role` (requireSuperAdmin)
- Frontend admin panel under `/admin/users`

### 2. Expanded Role System

Add more granular roles beyond `user` | `admin`:

```typescript
type UserRole =
  | "user" // Regular user
  | "support" // Support team member
  | "admin" // Super admin
  | "owner"; // Platform owner (highest privilege)
```

### 3. Permission-Based System

Move from role-based to permission-based access control:

```typescript
const permissions = {
  user: ["read:own-data"],
  support: ["read:all-data", "write:support-tickets"],
  admin: ["create:organisation", "read:all", "write:all"],
  owner: ["*"],
};

// Helper to check permissions
function hasPermission(user: User, permission: string): boolean {
  const userPermissions = permissions[user.role];
  return userPermissions.includes("*") || userPermissions.includes(permission);
}
```

### 4. Audit Log

Track role changes for compliance:

```typescript
export const roleAuditLog = pgTable("role_audit_log", {
  id: text("id").primaryKey(),
  userId: text("user_id").references(() => user.id),
  previousRole: text("previous_role"),
  newRole: text("new_role"),
  changedBy: text("changed_by").references(() => user.id),
  reason: text("reason"),
  timestamp: timestamp("timestamp").defaultNow(),
});
```

---

## Key Differences from Previous Plan

### What Changed

1. **✅ No manual schema editing**
   - Previously: Manual edits to `auth-schema.ts`
   - Now: Use `betterAuth()` config → regenerate via CLI

2. **✅ No backwards compatibility**
   - Previously: Maintained `SUPER_ADMIN_EMAILS` during transition
   - Now: Complete deprecation immediately

3. **✅ Simpler migration**
   - Previously: 3-phase gradual migration over 30-60 days
   - Now: Single deployment with migration script

4. **✅ Better-auth native**
   - Previously: Custom field implementation
   - Now: Using better-auth's `additionalFields` feature

### Why This Approach is Better

1. **Better-auth manages the schema** - We don't fight with CLI regeneration
2. **Automatic TypeScript inference** - Better type safety
3. **Cleaner codebase** - No backwards compatibility complexity
4. **Faster deployment** - One-time migration instead of gradual transition
5. **Less error-prone** - Following better-auth conventions

---

## Summary

This refactoring adds a `role` field to the user table using better-auth's native `additionalFields` configuration, making super admin status database-backed and automatically available in sessions. This solves the frontend [`ProtectedRoute`](apps/frontend/components/protected-route.tsx) issue with a clean, simple implementation.

**Key Benefits:**
✅ Frontend immediately works (checks `user.role`)  
✅ Database-backed, persistent role system  
✅ Native better-auth integration (auto-types, auto-session)  
✅ No manual schema editing needed  
✅ Clean deprecation of environment variable approach  
✅ Foundation for future RBAC system

**Implementation Effort:**

- Better-auth config: Trivial (add `additionalFields`)
- Schema regeneration: Simple (one CLI command)
- Backend updates: Medium (7 call sites to update)
- Frontend updates: Minimal (types only, logic already exists)
- Testing: Medium (multiple scenarios)

**Critical Path:**

1. Update `auth.ts` → Regenerate schema → Push to DB
2. Run migration script for existing admin
3. Update backend code (remove env variable logic)
4. Remove `SUPER_ADMIN_EMAILS` from env files
5. Test thoroughly
6. Deploy

**Estimated Timeline:**

- Development: 1-2 hours
- Testing: 1 hour
- Deployment: 30 minutes
- **Total: ~3-4 hours**
